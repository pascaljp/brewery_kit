/*
 * ATTENTION: The "eval" devtool has been used (maybe by default in mode: "development").
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
/******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "./monitoring/global.ts":
/*!******************************!*\
  !*** ./monitoring/global.ts ***!
  \******************************/
/***/ (function(__unused_webpack_module, exports, __webpack_require__) {

eval("\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", ({ value: true }));\nexports.Global = void 0;\nvar node_fetch_1 = __importDefault(__webpack_require__(/*! node-fetch */ \"node-fetch\"));\nvar Global = /** @class */ (function () {\n    function Global() {\n    }\n    Global.fetchContent = function (url, init) {\n        return __awaiter(this, void 0, void 0, function () {\n            var response;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, node_fetch_1.default(url, init)];\n                    case 1:\n                        response = _a.sent();\n                        if (!response.ok) {\n                            throw new Error('Response is not OK');\n                        }\n                        return [4 /*yield*/, response.text()];\n                    case 2: return [2 /*return*/, _a.sent()];\n                }\n            });\n        });\n    };\n    return Global;\n}());\nexports.Global = Global;\n\n\n//# sourceURL=webpack://brewery_kit/./monitoring/global.ts?");

/***/ }),

/***/ "./monitoring/index.ts":
/*!*****************************!*\
  !*** ./monitoring/index.ts ***!
  \*****************************/
/***/ (function(__unused_webpack_module, exports, __webpack_require__) {

eval("\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", ({ value: true }));\nvar IBS_TH1 = __webpack_require__(/*! ibs_th1 */ \"ibs_th1\");\n// import execSync from 'child_process';\nvar log4js_1 = __importDefault(__webpack_require__(/*! log4js */ \"log4js\"));\nvar moment_timezone_1 = __importDefault(__webpack_require__(/*! moment-timezone */ \"moment-timezone\"));\nvar notifier_1 = __webpack_require__(/*! ./notifier */ \"./monitoring/notifier.ts\");\nvar main_1 = __webpack_require__(/*! ./server/main */ \"./monitoring/server/main.ts\");\nvar InkbirdConfig = __importStar(__webpack_require__(/*! ./shared/config */ \"./monitoring/shared/config.ts\"));\nvar global_1 = __webpack_require__(/*! ./global */ \"./monitoring/global.ts\");\nvar MONITORING_FREQUENCY = 60; // Once in every 60 seconds.\nlog4js_1.default.addLayout('with_filename', function ( /*config*/) {\n    return function (logEvent /*Log4js.LoggingEvent*/) {\n        var level = logEvent.level.levelStr[0];\n        var time = moment_timezone_1.default(logEvent.startTime).tz('Asia/Tokyo').format('YYYYMMDD HHmmss.SSS');\n        var path = logEvent.fileName;\n        var file = path.substr(path.indexOf('brewery_kit') + 'brewery_kit/'.length);\n        return \"\" + level + time + \"] \" + file + \" \" + logEvent.data;\n    };\n});\nlog4js_1.default.configure({\n    appenders: {\n        out: { type: 'stdout', layout: { type: 'with_filename' } },\n        err: {\n            type: 'file',\n            filename: 'error.log',\n            pattern: '-yyyyMMdd',\n            backups: 366,\n            layout: { type: 'with_filename' },\n        },\n    },\n    categories: {\n        default: { appenders: ['out'], level: 'all', enableCallStack: true },\n        ibs_th1: { appenders: ['out', 'err'], level: 'warn', enableCallStack: true },\n    },\n});\nvar logger = log4js_1.default.getLogger();\nvar Inkbird = /** @class */ (function () {\n    function Inkbird() {\n    }\n    Inkbird.run = function () {\n        // Reboot the machine if there is no data in the past 5 minutes.\n        var watchdogId = setTimeout(function () {\n            logger.error('Seems like inkbird process is not working properly.');\n            logger.error('Rebooting the machine...');\n            try {\n                // const stdout = execSync('/sbin/reboot');\n                // logger.mark('Reboot command succeeded... Rebooting...');\n                // logger.mark(stdout);\n                process.exit(1);\n            }\n            catch (e) {\n                logger.error('Failed to reboot the machine.');\n                logger.error(e);\n            }\n        }, 300 * 1000);\n        // The watchdog does not prevent the program to terminate.\n        watchdogId.unref();\n        // device ID to unixtime.\n        var lastNotifyTimes = new Map();\n        function createCallback(notifier) {\n            var _this = this;\n            return function (data) { return __awaiter(_this, void 0, void 0, function () {\n                var currentUnixtime, lastNotifyTime, e_1;\n                return __generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0:\n                            currentUnixtime = moment_timezone_1.default().unix();\n                            lastNotifyTime = lastNotifyTimes.get(data.address);\n                            if (lastNotifyTime && Math.floor(lastNotifyTime / MONITORING_FREQUENCY) == Math.floor(currentUnixtime / MONITORING_FREQUENCY)) {\n                                return [2 /*return*/];\n                            }\n                            logger.trace(data.address, data.date, data.temperature, data.humidity, data.probeType, data.battery);\n                            lastNotifyTimes.set(data.address, currentUnixtime);\n                            _a.label = 1;\n                        case 1:\n                            _a.trys.push([1, 3, , 4]);\n                            return [4 /*yield*/, notifier.notifyInkbirdApi([{\n                                        deviceId: data.address,\n                                        unixtime: currentUnixtime,\n                                        temperature: data.temperature,\n                                        humidity: data.humidity,\n                                        battery: data.battery,\n                                        probeType: data.probeType,\n                                    }], false)];\n                        case 2:\n                            _a.sent();\n                            watchdogId.refresh();\n                            return [3 /*break*/, 4];\n                        case 3:\n                            e_1 = _a.sent();\n                            logger.error('Error in notifier.notifyInkbirdApi:', e_1);\n                            return [3 /*break*/, 4];\n                        case 4: return [2 /*return*/];\n                    }\n                });\n            }); };\n        }\n        var config = InkbirdConfig.getConfig();\n        logger.mark(\"Machine ID: \" + config.machineId);\n        var notifier = new notifier_1.Notifier(config.dataDir, config.machineId, global_1.Global);\n        notifier.init();\n        // Server needs to start up after config file is created.\n        var server = new main_1.Server();\n        server.start();\n        // Subscribe inkbird signals.\n        logger.mark('Inkbird monitoring program has started.');\n        var device = new IBS_TH1();\n        device.subscribeRealtimeData(createCallback(notifier));\n    };\n    return Inkbird;\n}());\nInkbird.run();\n\n\n//# sourceURL=webpack://brewery_kit/./monitoring/index.ts?");

/***/ }),

/***/ "./monitoring/notifier.ts":
/*!********************************!*\
  !*** ./monitoring/notifier.ts ***!
  \********************************/
/***/ (function(__unused_webpack_module, exports, __webpack_require__) {

eval("\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", ({ value: true }));\nexports.Notifier = void 0;\nvar fs = __importStar(__webpack_require__(/*! fs */ \"fs\"));\nvar Log4js = __importStar(__webpack_require__(/*! log4js */ \"log4js\"));\nvar async_lock_1 = __importDefault(__webpack_require__(/*! async-lock */ \"async-lock\"));\nvar Path = __importStar(__webpack_require__(/*! path */ \"path\"));\nvar logger = Log4js.getLogger();\n// A class that sends data to pascal's private server.\nvar Notifier = /** @class */ (function () {\n    function Notifier(tmpdir, machineId, global) {\n        this.tempDir_ = tmpdir;\n        this.machineId_ = machineId;\n        this.global_ = global;\n        this.filePath_ = Path.join(this.tempDir_, '' + new Date().getTime());\n        this.lock_ = new async_lock_1.default({ timeout: 3000 });\n        this.resending_ = false;\n        fs.mkdirSync(this.tempDir_, { recursive: true });\n    }\n    Notifier.prototype.getFilePath = function () {\n        return this.filePath_;\n    };\n    // Time consuming, but this task does not block anyting.\n    Notifier.prototype.init = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var _this = this;\n            return __generator(this, function (_a) {\n                setInterval(function () { _this.resendWholeData_(); }, 10 * 60 * 1000);\n                return [2 /*return*/, this.resendWholeData_()];\n            });\n        });\n    };\n    Notifier.prototype.notifyInkbirdApi = function (data, isBackfill) {\n        return __awaiter(this, void 0, void 0, function () {\n            var _i, data_1, entry, params;\n            var _this = this;\n            return __generator(this, function (_a) {\n                for (_i = 0, data_1 = data; _i < data_1.length; _i++) {\n                    entry = data_1[_i];\n                    if (!entry.deviceId && entry.address) {\n                        entry.deviceId = entry.address;\n                    }\n                    if (entry.deviceId === undefined ||\n                        entry.unixtime === undefined ||\n                        entry.temperature === undefined ||\n                        entry.humidity === undefined ||\n                        entry.battery === undefined) {\n                        throw new Error(\"Required fields are not set \" + entry.deviceId + \", \" + entry.unixtime + \",\" +\n                            (entry.temperature + \", \" + entry.humidity + \", \" + entry.battery));\n                    }\n                }\n                params = {\n                    machineId: this.machineId_,\n                    data: data,\n                    backfill: isBackfill\n                };\n                return [2 /*return*/, this.global_.fetchContent('https://brewery-app.com/api/client/saveInkbirdData', {\n                        method: 'POST',\n                        timeout: 5 * 1000,\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify(params),\n                    }).catch(function (e) {\n                        logger.error('Error in notifyInkbirdApi:', e.message);\n                        var promise = Promise.resolve();\n                        var _loop_1 = function (entry) {\n                            promise = promise.then(function () { return _this.saveToDisk_(entry); });\n                        };\n                        for (var _i = 0, data_2 = data; _i < data_2.length; _i++) {\n                            var entry = data_2[_i];\n                            _loop_1(entry);\n                        }\n                        return promise;\n                    })];\n            });\n        });\n    };\n    Notifier.prototype.saveToDisk_ = function (data) {\n        return __awaiter(this, void 0, void 0, function () {\n            var err_1;\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        _a.trys.push([0, 2, , 3]);\n                        return [4 /*yield*/, this.lock_.acquire('disk_lock', function () {\n                                try {\n                                    fs.appendFileSync(_this.filePath_, JSON.stringify(data) + '\\n');\n                                    logger.warn('Logged to local file.');\n                                    return;\n                                }\n                                catch (err) {\n                                    logger.error('Failed to append to file:', JSON.stringify(data), err);\n                                    throw new Error('Failed to append to file');\n                                }\n                            })];\n                    case 1:\n                        _a.sent();\n                        return [3 /*break*/, 3];\n                    case 2:\n                        err_1 = _a.sent();\n                        logger.error('Failed to acquire lock:', err_1.message, JSON.stringify(data));\n                        throw new Error('Failed to acquire lock');\n                    case 3: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    Notifier.prototype.resendWholeData_ = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var files, _i, files_1, file, fullPath, entries, fd, position, length_1, buffer, _a, entries_1, entry;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        if (this.resending_) {\n                            return [2 /*return*/];\n                        }\n                        this.resending_ = true;\n                        files = fs.readdirSync(this.tempDir_, { withFileTypes: true });\n                        // New data will be stored to a new file.\n                        this.filePath_ = Path.join(this.tempDir_, '' + new Date().getTime());\n                        _i = 0, files_1 = files;\n                        _b.label = 1;\n                    case 1:\n                        if (!(_i < files_1.length)) return [3 /*break*/, 10];\n                        file = files_1[_i];\n                        if (!file.isFile()) {\n                            return [3 /*break*/, 9];\n                        }\n                        fullPath = Path.join(this.tempDir_, file.name);\n                        entries = fs.readFileSync(fullPath, { encoding: 'utf8' }).split('\\n');\n                        fd = fs.openSync(fullPath, 'r+');\n                        position = 0;\n                        length_1 = 0;\n                        buffer = [];\n                        _a = 0, entries_1 = entries;\n                        _b.label = 2;\n                    case 2:\n                        if (!(_a < entries_1.length)) return [3 /*break*/, 6];\n                        entry = entries_1[_a];\n                        if (!/\\S/.test(entry)) return [3 /*break*/, 4];\n                        try {\n                            buffer.push(JSON.parse(entry));\n                        }\n                        catch (e) { }\n                        if (!(buffer.length >= 100)) return [3 /*break*/, 4];\n                        return [4 /*yield*/, this.notifyInkbirdApi(buffer, true)];\n                    case 3:\n                        _b.sent();\n                        fs.writeSync(fd, ' '.repeat(length_1 - 1), position);\n                        position += length_1;\n                        length_1 = 0;\n                        buffer.splice(0);\n                        _b.label = 4;\n                    case 4:\n                        length_1 += entry.length + '\\n'.length;\n                        _b.label = 5;\n                    case 5:\n                        _a++;\n                        return [3 /*break*/, 2];\n                    case 6:\n                        if (!buffer.length) return [3 /*break*/, 8];\n                        return [4 /*yield*/, this.notifyInkbirdApi(buffer, true)];\n                    case 7:\n                        _b.sent();\n                        _b.label = 8;\n                    case 8:\n                        fs.closeSync(fd);\n                        fs.unlinkSync(fullPath);\n                        _b.label = 9;\n                    case 9:\n                        _i++;\n                        return [3 /*break*/, 1];\n                    case 10:\n                        this.resending_ = false;\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    return Notifier;\n}());\nexports.Notifier = Notifier;\n\n\n//# sourceURL=webpack://brewery_kit/./monitoring/notifier.ts?");

/***/ }),

/***/ "./monitoring/server/admin/index.ts":
/*!******************************************!*\
  !*** ./monitoring/server/admin/index.ts ***!
  \******************************************/
/***/ (function(__unused_webpack_module, exports, __webpack_require__) {

eval("\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", ({ value: true }));\nexports.Admin = void 0;\nvar child_process_1 = __webpack_require__(/*! child_process */ \"child_process\");\nvar firebase_1 = __importDefault(__webpack_require__(/*! firebase */ \"firebase\"));\nvar Admin = /** @class */ (function () {\n    function Admin() {\n        var _this = this;\n        firebase_1.default.initializeApp({\n            apiKey: 'AIzaSyBT6_J6eKuV1gX5zJZQHMyCsb4LSxfi68Y',\n            authDomain: 'brewery-kit.firebaseapp.com',\n            databaseURL: 'https://brewery-kit-dev.firebaseio.com',\n            projectId: 'brewery-kit',\n            storageBucket: 'brewery-kit.appspot.com',\n            messagingSenderId: '567787916313',\n            appId: '1:567787916313:web:b31c427a013911da88ee88',\n        });\n        var reqRoot = firebase_1.default.database().ref('admin/testMachine/request');\n        var resRoot = firebase_1.default.database().ref('admin/testMachine/response');\n        var callback = function (snapshot) { return __awaiter(_this, void 0, void 0, function () {\n            var command, result, o, key, e_1;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        command = snapshot.val();\n                        console.log(command);\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, 3, , 4]);\n                        result = child_process_1.execSync(command + ' 2>/dev/null').toString();\n                        o = {};\n                        key = snapshot.key;\n                        o[key] = result;\n                        return [4 /*yield*/, resRoot.update(o)];\n                    case 2:\n                        _a.sent();\n                        return [3 /*break*/, 4];\n                    case 3:\n                        e_1 = _a.sent();\n                        console.log(e_1.stdout.toString());\n                        console.warn(e_1.stderr.toString());\n                        return [3 /*break*/, 4];\n                    case 4: return [2 /*return*/];\n                }\n            });\n        }); };\n        reqRoot.orderByKey().limitToLast(1).once('value').then(function (snapshot) {\n            var lastChild = Object.entries(snapshot.val())[0];\n            var lastKey = lastChild ? lastChild[0] : '';\n            reqRoot.orderByKey().startAfter(lastKey).on('child_added', callback);\n            reqRoot.orderByKey().startAfter(lastKey).on('child_changed', callback);\n        });\n    }\n    return Admin;\n}());\nexports.Admin = Admin;\n\n\n//# sourceURL=webpack://brewery_kit/./monitoring/server/admin/index.ts?");

/***/ }),

/***/ "./monitoring/server/main.ts":
/*!***********************************!*\
  !*** ./monitoring/server/main.ts ***!
  \***********************************/
/***/ (function(__unused_webpack_module, exports, __webpack_require__) {

eval("\n// How to authenticate users:\n// 1. monitoring program uploads machineId to a server.\n// 2. user accesses the server, and get an IP address of the monitoring program.\n// 3. user accesses the monitoring program to get the machineID.\n// 4. user sends the machineId to the server.\n// 5. now the server knows the user has an access to the machine.\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", ({ value: true }));\nexports.Server = void 0;\nvar express_1 = __importDefault(__webpack_require__(/*! express */ \"express\"));\nvar node_fetch_1 = __importDefault(__webpack_require__(/*! node-fetch */ \"node-fetch\"));\nvar log4js_1 = __importDefault(__webpack_require__(/*! log4js */ \"log4js\"));\nvar os_1 = __importDefault(__webpack_require__(/*! os */ \"os\"));\nvar InkbirdConfig = __importStar(__webpack_require__(/*! ../shared/config */ \"./monitoring/shared/config.ts\"));\nvar admin_1 = __webpack_require__(/*! ./admin */ \"./monitoring/server/admin/index.ts\");\nvar logger = log4js_1.default.getLogger();\nvar Server = /** @class */ (function () {\n    function Server() {\n        this.app_ = express_1.default();\n        this.server_ = null;\n        this.machineId_ = InkbirdConfig.getConfig().machineId;\n        this.app_.get('/', function (_req, res) { res.send('OK'); });\n        this.app_.get('/getMachineId', this.getMachineId_.bind(this));\n        new admin_1.Admin();\n    }\n    Server.prototype.start = function () {\n        var _this = this;\n        logger.mark('Starting up a server...');\n        this.server_ = this.app_.listen(0, function () {\n            logger.info('Server started.');\n            _this.notifyLocalIpAddress_(_this.machineId_);\n        });\n    };\n    Server.prototype.notifyLocalIpAddress_ = function (machineId) {\n        return __awaiter(this, void 0, void 0, function () {\n            var address, port, interfaces, _i, _a, _b, entries, _c, entries_1, entry;\n            return __generator(this, function (_d) {\n                switch (_d.label) {\n                    case 0:\n                        if (!this.server_) {\n                            return [2 /*return*/];\n                        }\n                        address = this.server_.address();\n                        if (!address || typeof address === 'string') {\n                            return [2 /*return*/];\n                        }\n                        port = address.port;\n                        interfaces = os_1.default.networkInterfaces();\n                        _i = 0, _a = Object.entries(interfaces);\n                        _d.label = 1;\n                    case 1:\n                        if (!(_i < _a.length)) return [3 /*break*/, 6];\n                        _b = _a[_i], entries = _b[1];\n                        if (!Array.isArray(entries)) {\n                            return [3 /*break*/, 5];\n                        }\n                        _c = 0, entries_1 = entries;\n                        _d.label = 2;\n                    case 2:\n                        if (!(_c < entries_1.length)) return [3 /*break*/, 5];\n                        entry = entries_1[_c];\n                        if (entry.family != 'IPv4') {\n                            return [3 /*break*/, 4];\n                        }\n                        if (entry.internal) {\n                            return [3 /*break*/, 4];\n                        }\n                        return [4 /*yield*/, node_fetch_1.default('https://brewery-app.com/api/client/saveIpAddress', {\n                                method: 'POST',\n                                headers: { 'Content-Type': 'application/json; charset=utf-8' },\n                                redirect: 'follow',\n                                body: JSON.stringify({\n                                    machineId: machineId,\n                                    ipAddress: entry.address,\n                                    port: port,\n                                }),\n                            })];\n                    case 3:\n                        _d.sent();\n                        logger.info(\"Notified: \" + entry.address + \":\" + port);\n                        _d.label = 4;\n                    case 4:\n                        _c++;\n                        return [3 /*break*/, 2];\n                    case 5:\n                        _i++;\n                        return [3 /*break*/, 1];\n                    case 6: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    Server.prototype.getMachineId_ = function (_req, res) {\n        res.header('Content-Type', 'application/json; charset=utf-8');\n        res.header('Access-Control-Allow-Origin', 'https://brewery-app.com');\n        res.header('Access-Control-Allow-Origin', 'http://brewery-app.com');\n        res.json({ status: 'ok', machineId: this.machineId_ });\n    };\n    return Server;\n}());\nexports.Server = Server;\n\n\n//# sourceURL=webpack://brewery_kit/./monitoring/server/main.ts?");

/***/ }),

/***/ "./monitoring/shared/config.ts":
/*!*************************************!*\
  !*** ./monitoring/shared/config.ts ***!
  \*************************************/
/***/ (function(__unused_webpack_module, exports, __webpack_require__) {

eval("\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nObject.defineProperty(exports, \"__esModule\", ({ value: true }));\nexports.getConfig = void 0;\nvar crypto = __importStar(__webpack_require__(/*! crypto */ \"crypto\"));\nvar child_process_1 = __webpack_require__(/*! child_process */ \"child_process\");\nvar fs = __importStar(__webpack_require__(/*! fs */ \"fs\"));\nvar path = __importStar(__webpack_require__(/*! path */ \"path\"));\n/** Returns whether the field is updated. */\nfunction getMachineId(config) {\n    if (config.machineId) {\n        return config.machineId;\n    }\n    var S = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n    return ('random-' +\n        Array.from(crypto.randomFillSync(new Uint8Array(16)))\n            .map(function (n) { return S[n % S.length]; })\n            .join(''));\n}\nfunction getDataDir() {\n    return process.env['USER'] == 'docker'\n        ? '/mnt/inkbird'\n        : \"/home/\" + process.env['USER'] + \"/.inkbird\";\n}\nfunction getConfigInternal() {\n    var configPath = path.join(getDataDir(), 'config.json');\n    var partialConfig = JSON.parse(fs.readFileSync(configPath, { encoding: 'utf8' }));\n    if (partialConfig.machineId && partialConfig.dataDir) {\n        var machineId = partialConfig.machineId;\n        var dataDir = partialConfig.dataDir;\n        return { machineId: machineId, dataDir: dataDir };\n    }\n    var config = {\n        machineId: getMachineId(partialConfig),\n        dataDir: getDataDir(),\n    };\n    var user = process.env['USER'];\n    child_process_1.execSync(\"sudo mkdir -p \" + config.dataDir);\n    child_process_1.execSync(\"sudo chown \" + user + \":\" + user + \" \" + config.dataDir);\n    child_process_1.execSync(\"mkdir -p \" + config.dataDir);\n    fs.writeFileSync(configPath, JSON.stringify(config));\n    return config;\n}\nvar cachedConfig = (function () {\n    try {\n        return getConfigInternal();\n    }\n    catch (e) {\n        console.error(e);\n        throw new Error('Config file was not found. Try running maintenance/update_job.sh');\n    }\n})();\nfunction getConfig() {\n    return cachedConfig;\n}\nexports.getConfig = getConfig;\n\n\n//# sourceURL=webpack://brewery_kit/./monitoring/shared/config.ts?");

/***/ }),

/***/ "async-lock":
/*!*****************************!*\
  !*** external "async-lock" ***!
  \*****************************/
/***/ ((module) => {

module.exports = require("async-lock");;

/***/ }),

/***/ "child_process":
/*!********************************!*\
  !*** external "child_process" ***!
  \********************************/
/***/ ((module) => {

module.exports = require("child_process");;

/***/ }),

/***/ "crypto":
/*!*************************!*\
  !*** external "crypto" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("crypto");;

/***/ }),

/***/ "express":
/*!**************************!*\
  !*** external "express" ***!
  \**************************/
/***/ ((module) => {

module.exports = require("express");;

/***/ }),

/***/ "firebase":
/*!***************************!*\
  !*** external "firebase" ***!
  \***************************/
/***/ ((module) => {

module.exports = require("firebase");;

/***/ }),

/***/ "fs":
/*!*********************!*\
  !*** external "fs" ***!
  \*********************/
/***/ ((module) => {

module.exports = require("fs");;

/***/ }),

/***/ "ibs_th1":
/*!**************************!*\
  !*** external "ibs_th1" ***!
  \**************************/
/***/ ((module) => {

module.exports = require("ibs_th1");;

/***/ }),

/***/ "log4js":
/*!*************************!*\
  !*** external "log4js" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("log4js");;

/***/ }),

/***/ "moment-timezone":
/*!**********************************!*\
  !*** external "moment-timezone" ***!
  \**********************************/
/***/ ((module) => {

module.exports = require("moment-timezone");;

/***/ }),

/***/ "node-fetch":
/*!*****************************!*\
  !*** external "node-fetch" ***!
  \*****************************/
/***/ ((module) => {

module.exports = require("node-fetch");;

/***/ }),

/***/ "os":
/*!*********************!*\
  !*** external "os" ***!
  \*********************/
/***/ ((module) => {

module.exports = require("os");;

/***/ }),

/***/ "path":
/*!***********************!*\
  !*** external "path" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("path");;

/***/ })

/******/ 	});
/************************************************************************/
/******/ 	// The module cache
/******/ 	var __webpack_module_cache__ = {};
/******/ 	
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/ 		// Check if module is in cache
/******/ 		var cachedModule = __webpack_module_cache__[moduleId];
/******/ 		if (cachedModule !== undefined) {
/******/ 			return cachedModule.exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = __webpack_module_cache__[moduleId] = {
/******/ 			// no module.id needed
/******/ 			// no module.loaded needed
/******/ 			exports: {}
/******/ 		};
/******/ 	
/******/ 		// Execute the module function
/******/ 		__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/ 	
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/ 	
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	// This entry module is referenced by other modules so it can't be inlined
/******/ 	var __webpack_exports__ = __webpack_require__("./monitoring/index.ts");
/******/ 	
/******/ })()
;